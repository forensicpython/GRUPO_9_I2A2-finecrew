# Funcionamento do Sistema FinaCrew - Arquitetura Multi-Agente

## üìã Vis√£o Geral

O **FinaCrew** √© um sistema multi-agente baseado no framework **CrewAI** que automatiza o processamento de Vale Refei√ß√£o/Vale Alimenta√ß√£o (VR/VA) atrav√©s de intelig√™ncia artificial. O sistema substitui processamento manual por uma solu√ß√£o inteligente que aplica regras de neg√≥cio complexas de forma aut√¥noma.

## üéØ Objetivo do Sistema

- **Automatizar** o c√°lculo de VR/VA para funcion√°rios
- **Aplicar regras empresariais** conforme especifica√ß√µes do PDF
- **Gerar planilhas** finais com valida√ß√µes completas
- **Fornecer auditoria** completa do processamento
- **Garantir conformidade** com crit√©rios de elegibilidade

## ü§ñ Arquitetura dos Agentes

O sistema possui **3 agentes principais** que trabalham de forma sequencial e colaborativa:

### **1. File Manager Agent (Gerenciador de Arquivos)**

**üìÅ Especialista em Normaliza√ß√£o e Carregamento de Dados**

- **Fun√ß√£o Principal**: Descobrir, validar e normalizar arquivos Excel
- **Responsabilidades**:
  - Localizar arquivos nas pastas `raw_data` e `temp_uploads`
  - Validar integridade dos dados de entrada
  - Normalizar nomes de colunas e estruturas
  - Carregar as **5 bases obrigat√≥rias**:
    - Base de Funcion√°rios Ativos
    - Base de F√©rias
    - Base de Desligados
    - Base de Admitidos
    - Base Sindicato x Valor
  - Garantir qualidade dos dados antes do processamento

- **Ferramentas Utilizadas**:
  - `file_discovery_tool`: Descoberta autom√°tica de arquivos
  - `spreadsheet_analyzer_tool`: An√°lise de estrutura das planilhas

- **Localiza√ß√£o**: `config/agents.yaml` ‚Üí `file_manager_agent`

### **2. Exclusions Agent (Agente de Exclus√µes)**

**üö´ Especialista em Regras de Neg√≥cio e Exclus√µes**

- **Fun√ß√£o Principal**: Aplicar crit√©rios de elegibilidade e exclus√µes
- **Responsabilidades**:
  - Aplicar **exclus√µes obrigat√≥rias**:
    - Diretores
    - Estagi√°rios
    - Aprendizes
    - Funcion√°rios afastados
    - Funcion√°rios no exterior
  - Implementar **regra de desligamento**:
    - At√© dia 15: n√£o paga VR/VA
    - Ap√≥s dia 15: valor proporcional
  - Validar elegibilidade conforme crit√©rios empresariais
  - Gerar **relat√≥rio de auditoria** dos funcion√°rios exclu√≠dos
  - Aplicar regras espec√≠ficas por sindicato

- **Ferramentas Utilizadas**:
  - `working_days_calculator_tool`: C√°lculo de dias √∫teis

- **Localiza√ß√£o**: `config/agents.yaml` ‚Üí `exclusions_agent`

### **3. Coordinator Agent (Agente Coordenador)**

**üéØ Coordenador Geral do Processamento VR/VA**

- **Fun√ß√£o Principal**: Orquestrar o fluxo completo e gerar sa√≠das finais
- **Responsabilidades**:
  - Coordenar todo o fluxo de processamento
  - Calcular valores finais com divis√£o:
    - **80% empresa**
    - **20% funcion√°rio**
  - Gerar **planilha consolidada** `VR MENSAL 05.2025.xlsx`
  - Coordenar cria√ß√£o de todos os arquivos de sa√≠da
  - Validar resultados finais
  - Gerar relat√≥rios de auditoria

- **Ferramentas Utilizadas**:
  - `model_excel_generator_tool`: Gera√ß√£o de planilhas Excel

- **Localiza√ß√£o**: `config/agents.yaml` ‚Üí `coordinator_agent`

## üìã Fluxo de Tarefas Sequenciais

O sistema executa **5 tarefas principais** em sequ√™ncia rigorosa:

### **Task 1: Descoberta de Arquivos** üîç
- **Agente Respons√°vel**: File Manager Agent
- **Objetivo**: Localizar e catalogar todos os arquivos Excel necess√°rios
- **Processo**:
  - Scan das pastas `raw_data` e `temp_uploads`
  - Valida√ß√£o de formatos (.xlsx, .xls)
  - Verifica√ß√£o de integridade dos arquivos
- **Output**: Lista completa dos arquivos encontrados e validados

### **Task 2: An√°lise de Estrutura** üìä
- **Agente Respons√°vel**: File Manager Agent
- **Objetivo**: Analisar estrutura e conte√∫do de cada planilha
- **Processo**:
  - Mapeamento de colunas por arquivo
  - Identifica√ß√£o de tipos de dados
  - Valida√ß√£o de estruturas esperadas
- **Output**: Mapeamento detalhado das colunas e dados de cada base

### **Task 3: Consolida√ß√£o da Base** üîó
- **Agente Respons√°vel**: File Manager Agent
- **Objetivo**: Unificar as 5 fontes de dados em uma base consolidada
- **Processo**:
  - Normaliza√ß√£o de estruturas de dados
  - Merge inteligente das bases
  - Resolu√ß√£o de conflitos de dados
  - Cria√ß√£o de chaves √∫nicas
- **Output**: Base de dados √∫nica e normalizada para processamento

### **Task 4: Aplica√ß√£o de Exclus√µes** ‚ùå
- **Agente Respons√°vel**: Exclusions Agent
- **Objetivo**: Aplicar todas as regras de exclus√£o e eligibilidade
- **Processo**:
  - Identifica√ß√£o de funcion√°rios por categoria
  - Aplica√ß√£o de regras de desligamento
  - Valida√ß√£o de crit√©rios de elegibilidade
  - C√°lculo de dias √∫teis por funcion√°rio
- **Output**:
  - Lista final de funcion√°rios eleg√≠veis
  - Relat√≥rio detalhado de exclus√µes para auditoria

### **Task 5: Gera√ß√£o dos Arquivos Finais** üìÑ
- **Agente Respons√°vel**: Coordinator Agent
- **Objetivo**: Calcular valores e gerar planilhas finais
- **Processo**:
  - C√°lculo de valores VR/VA por funcion√°rio
  - Aplica√ß√£o da divis√£o 80% empresa / 20% funcion√°rio
  - Gera√ß√£o de planilhas formatadas
  - Valida√ß√£o de totais e consist√™ncia
- **Output**:
  - `VR MENSAL 05.2025.xlsx` (planilha principal)
  - `FUNCIONARIOS_EXCLUIDOS_AUDITORIA.xlsx` (relat√≥rio de exclus√µes)

## üîß Sistema de An√°lise Inteligente

### **Agente Analisador de Resultados**

Substitu√≠mos a extra√ß√£o por regex por um **agente analisador especializado**:

**Arquivo**: `tools/results_analyzer_agent_tool.py`

**Caracter√≠sticas**:
- **LLM**: Groq (Llama 3.3 70B Versatile)
- **Fun√ß√£o**: Extrair dados estruturados do processamento
- **Valida√ß√µes**: Aplicar regras de neg√≥cio do PDF empresarial
- **Output**: JSON estruturado com todos os dados necess√°rios

**Valida√ß√µes Realizadas**:
- ‚úÖ Regras de sindicato aplicadas
- ‚úÖ Exclus√µes aplicadas corretamente
- ‚úÖ Regra de desligamento implementada
- ‚úÖ Divis√£o de custos 80%/20% correta

**Exemplo de Output**:
```json
{
  "funcionarios_elegiveis": 1719,
  "valor_total_vr": 1385943.75,
  "valor_empresa": 1108755.00,
  "valor_funcionario": 277188.75,
  "arquivos_gerados": ["VR MENSAL 05.2025.xlsx", "FUNCIONARIOS_EXCLUIDOS_AUDITORIA.xlsx"],
  "tempo_processamento": "Real-time",
  "validacoes": {
    "regras_sindicato_aplicadas": true,
    "exclusoes_aplicadas": true,
    "regra_desligamento_aplicada": true,
    "divisao_custo_correta": true
  },
  "metodo_extracao": "agente_analisador"
}
```

## üåê Integra√ß√£o Sistema Completo

### **Backend (Flask API)** üêç

**Arquivo Principal**: `api/app.py`

**Endpoints Principais**:
- `/api/process`: Orquestra todo o processamento VR/VA
- `/api/upload`: Upload de arquivos Excel
- `/api/download/<filename>`: Download de resultados
- `/api/test-groq`: Teste de conectividade com IA

**Fluxo de Processamento**:
1. Recebe arquivos via upload
2. Configura credenciais Groq via headers
3. Inicia captura de logs dos agentes
4. Processa dados reais via `real_data_processor_tool`
5. Analisa resultados via `results_analyzer_agent_tool`
6. Retorna dados estruturados + downloads dispon√≠veis

### **Frontend (React + Material-UI)** ‚öõÔ∏è

**Caracter√≠sticas**:
- Interface moderna e responsiva
- Upload drag-and-drop de arquivos
- Configura√ß√£o de credenciais Groq API
- Teste de conectividade em tempo real
- Download autom√°tico dos resultados
- Monitoramento de progresso

**P√°ginas Principais**:
- **ConfigurationPage**: Configura√ß√£o de credenciais
- **ProcessingPage**: Upload e processamento
- **ResultsPage**: Visualiza√ß√£o e download

### **Sistema de Logging e Auditoria** üìù

**Arquivo**: `tools/agent_logger_tool.py`

**Caracter√≠sticas**:
- **Captura completa** de conversas dos agentes
- **Logs estruturados** em formato JSON e texto
- **Timestamps** precisos para auditoria
- **Rastreamento** de todas as decis√µes dos agentes
- **Download** dos logs para transpar√™ncia

**Estrutura dos Logs**:
```json
{
  "session_info": {
    "start_time": "2025-01-XX",
    "duration_seconds": 120,
    "total_logs": 45
  },
  "logs": [
    {
      "timestamp": "2025-01-XX 10:30:00",
      "agent": "File Manager Agent",
      "level": "INFO",
      "message": "Arquivos descobertos: 5 bases encontradas"
    }
  ],
  "summary": {
    "agents_involved": ["File Manager", "Exclusions", "Coordinator"],
    "log_levels": ["INFO", "LOG", "RESULT"]
  }
}
```

## ‚ö° Vantagens da Arquitetura Multi-Agente

### **1. Especializa√ß√£o** üéØ
- Cada agente √© expert em sua √°rea espec√≠fica
- Conhecimento profundo das regras de neg√≥cio
- Otimiza√ß√£o de performance por especializa√ß√£o

### **2. Flexibilidade** üîÑ
- F√°cil modifica√ß√£o de regras por agente
- Adi√ß√£o de novos agentes sem impacto
- Configura√ß√£o via YAML para mudan√ßas r√°pidas

### **3. Transpar√™ncia** üîç
- Logs detalhados de todas as decis√µes
- Rastreabilidade completa do processamento
- Auditoria de cada etapa do fluxo

### **4. Escalabilidade** üìà
- Possibilidade de adicionar novos agentes
- Paraleliza√ß√£o de tarefas independentes
- Arquitetura preparada para crescimento

### **5. Intelig√™ncia** üß†
- Uso de LLM para an√°lise contextual
- Substitui√ß√£o de regex fixo por compreens√£o sem√¢ntica
- Adapta√ß√£o autom√°tica a varia√ß√µes nos dados

## üõ†Ô∏è Tecnologias Utilizadas

### **Framework de Agentes**
- **CrewAI**: Orquestra√ß√£o de agentes
- **LangChain**: Base para ferramentas de IA

### **Intelig√™ncia Artificial**
- **Groq API**: Processamento de linguagem natural
- **Llama 3.3 70B**: Modelo de linguagem principal

### **Backend**
- **Flask**: API REST
- **Python 3.x**: Linguagem principal
- **Pandas**: Manipula√ß√£o de dados
- **OpenPyXL**: Processamento de Excel

### **Frontend**
- **React**: Interface de usu√°rio
- **Material-UI**: Componentes visuais
- **TypeScript**: Tipagem est√°tica

### **Configura√ß√£o**
- **YAML**: Configura√ß√£o de agentes e tarefas
- **Environment Variables**: Credenciais e configura√ß√µes

## üìÅ Estrutura de Arquivos

```
FinaCrew/
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îî‚îÄ‚îÄ app.py                 # API Flask principal
‚îú‚îÄ‚îÄ config/
‚îÇ   ‚îú‚îÄ‚îÄ agents.yaml           # Configura√ß√£o dos agentes
‚îÇ   ‚îî‚îÄ‚îÄ tasks.yaml            # Defini√ß√£o das tarefas
‚îú‚îÄ‚îÄ tools/
‚îÇ   ‚îú‚îÄ‚îÄ agent_logger_tool.py           # Sistema de logging
‚îÇ   ‚îú‚îÄ‚îÄ results_analyzer_agent_tool.py # Analisador inteligente
‚îÇ   ‚îú‚îÄ‚îÄ real_data_processor_tool.py    # Processador de dados
‚îÇ   ‚îî‚îÄ‚îÄ [outras ferramentas]
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îî‚îÄ‚îÄ src/
‚îÇ       ‚îú‚îÄ‚îÄ pages/            # P√°ginas React
‚îÇ       ‚îî‚îÄ‚îÄ types/            # Defini√ß√µes TypeScript
‚îú‚îÄ‚îÄ finacrew.py               # Orquestrador principal CrewAI
‚îî‚îÄ‚îÄ start_finecrew.sh         # Script de inicializa√ß√£o
```

## üéØ Conclus√£o

O **FinaCrew** representa uma evolu√ß√£o significativa no processamento automatizado de VR/VA, combinando:

- **Intelig√™ncia Artificial** para compreens√£o sem√¢ntica
- **Arquitetura Multi-Agente** para especializa√ß√£o
- **Interface Moderna** para usabilidade
- **Auditoria Completa** para conformidade
- **Flexibilidade** para adapta√ß√µes futuras

O sistema garante **conformidade total** com as especifica√ß√µes empresariais atrav√©s da colabora√ß√£o inteligente entre agentes especializados, cada um executando sua fun√ß√£o no fluxo de processamento VR/VA com precis√£o e transpar√™ncia.